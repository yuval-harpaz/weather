<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Weather Stations Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="logo.jpg">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
  <!-- Common map styles -->
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div id="floating-title">
  <h1>תחנות מזג אוויר - מפת תחנות IMS</h1>
  <div class="data-source">
    <span>נתונים מ</span>
    <a href="https://ims.gov.il/en/data_gov" target="_blank" rel="noopener">
      <img src="https://ims.gov.il/themes/imst/ims/images/logo.jpg" alt="IMS" class="ims-logo">
    </a>
  </div>
</div>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// Initialize map centered on Israel
const map = L.map('map').setView([31.5, 35.0], 8);

// Tile layer
L.tileLayer('https://cdnil.govmap.gov.il/xyz/heb/{z}/{x}/{y}.png', {
  attribution: '© המרכז למיפוי ישראל www.govmap.gov.il'
}).addTo(map);


// Color palette for different regions
const regionColors = {
  6: '#e41a1c',   // Red
  7: '#377eb8',   // Blue
  8: '#4daf4a',   // Green
  9: '#984ea3',   // Purple
  10: '#ff7f00',  // Orange
  11: '#ffff33',  // Yellow
  12: '#a65628',  // Brown
  13: '#f781bf',  // Pink
  14: '#999999',  // Gray
  15: '#66c2a5'   // Teal
};

// Parse location string from CSV
function parseLocation(locStr) {
  try {
    // Location format: "{'latitude': 32.8174, 'longitude': 35.7622}"
    const latMatch = locStr.match(/latitude['"]*:\s*([\d.]+)/);
    const lngMatch = locStr.match(/longitude['"]*:\s*([\d.]+)/);
    if (latMatch && lngMatch) {
      return {
        lat: parseFloat(latMatch[1]),
        lng: parseFloat(lngMatch[1])
      };
    }
  } catch (e) {
    console.error('Error parsing location:', locStr, e);
  }
  return null;
}

// Convert uppercase text to proper case
function toProperCase(text) {
  return text.split(' ').map(word => {
    if (word.length === 0) return word;
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
}

// Load both CSVs
Promise.all([
  fetch('https://raw.githubusercontent.com/yuval-harpaz/weather/main/data/ims_stations.csv').then(r => r.text()),
  fetch('https://raw.githubusercontent.com/yuval-harpaz/weather/main/data/ims_regions.csv').then(r => r.text())
]).then(([stationsCsv, regionsCsv]) => {
    const data = Papa.parse(stationsCsv, { header: true, skipEmptyLines: true }).data;
    const regionsData = Papa.parse(regionsCsv, { header: true, skipEmptyLines: true }).data;
    
    // Create region name mapping
    const regionNames = {};
    regionsData.forEach(row => {
      const regionId = parseInt(row.regionId);
      if (!isNaN(regionId) && row.name) {
        regionNames[regionId] = toProperCase(row.name);
      }
    });
    
    // Count stations by region
    const regionCounts = {};
    const validStations = [];
    
    data.forEach(row => {
      const location = parseLocation(row.location);
      if (location && location.lat && location.lng) {
        const regionId = parseInt(row.regionId);
        if (!isNaN(regionId)) {
          regionCounts[regionId] = (regionCounts[regionId] || 0) + 1;
          validStations.push({
            name: row.name,
            stationId: row.stationId,
            lat: location.lat,
            lng: location.lng,
            regionId: regionId,
            active: row.active === 'True'
          });
        }
      }
    });
    
    console.log(`Loaded ${validStations.length} stations`);
    console.log('Region counts:', regionCounts);
    
    // Add markers for each station
    validStations.forEach(station => {
      const color = regionColors[station.regionId] || '#999999';
      const activeText = station.active ? 'פעילה' : 'לא פעילה';
      
      const regionName = regionNames[station.regionId] || `אזור ${station.regionId}`;
      
      const popup = `<div dir="rtl" style="text-align: right; font-size: 1.1em;">
        <strong>${station.name}</strong><br>
        מזהה תחנה: ${station.stationId}<br>
        אזור: ${regionName}<br>
        סטטוס: ${activeText}
      </div>`;
      
      L.circleMarker([station.lat, station.lng], {
        radius: 6,
        fillColor: color,
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map).bindPopup(popup);
    });
    
    // Add legend
    const legend = L.control({ position: 'topright' });
    legend.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<div dir="rtl" style="text-align: right;"><strong>אזורים</strong><br>';
      
      // Sort regions by ID
      const sortedRegions = Object.keys(regionCounts).sort((a, b) => parseInt(a) - parseInt(b));
      
      sortedRegions.forEach(regionId => {
        const color = regionColors[regionId] || '#999999';
        const count = regionCounts[regionId];
        const regionName = regionNames[regionId] || `אזור ${regionId}`;
        div.innerHTML += `
          <div class="legend-item">
            <span><span class="legend-color" style="background-color: ${color};"></span>${regionName}</span>
            <span style="margin-right: 10px;">(${count})</span>
          </div>`;
      });
      
      div.innerHTML += '</div>';
      return div;
    };
    legend.addTo(map);
  })
  .catch(error => {
    console.error('Error loading data:', error);
  });

</script>

</body>
</html>
